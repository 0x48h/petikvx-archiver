VERSION 5.00
Begin VB.Form Form1 
   BorderStyle     =   1  'Fixed Single
   Caption         =   "Malwares Analyses Tools"
   ClientHeight    =   8865
   ClientLeft      =   45
   ClientTop       =   435
   ClientWidth     =   8775
   Icon            =   "Form1.frx":0000
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   ScaleHeight     =   8865
   ScaleWidth      =   8775
   StartUpPosition =   2  'CenterScreen
   Begin VB.Frame Frame2 
      Caption         =   "Vérifier les fichiers non soumis à VirusTotal"
      Height          =   4095
      Left            =   120
      TabIndex        =   10
      Top             =   4320
      Width           =   8535
      Begin VB.TextBox txtdossiercollection 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   285
         Left            =   120
         TabIndex        =   17
         Top             =   3120
         Width           =   2655
      End
      Begin VB.CommandButton Command9 
         Caption         =   "Copier les fichiers à traiter"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   13.5
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   2880
         TabIndex        =   16
         Top             =   3480
         Width           =   5415
      End
      Begin VB.ListBox lst_mal_trait 
         Height          =   2595
         Left            =   2880
         MultiSelect     =   2  'Extended
         TabIndex        =   15
         Top             =   360
         Width           =   5415
      End
      Begin VB.CommandButton Command8 
         Caption         =   "Annuler"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   1560
         TabIndex        =   14
         Top             =   3480
         Width           =   1215
      End
      Begin VB.CommandButton Command7 
         Caption         =   "Scan"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   120
         TabIndex        =   13
         Top             =   3480
         Width           =   1215
      End
      Begin VB.DirListBox Dir2 
         Height          =   2115
         Left            =   120
         TabIndex        =   12
         Top             =   960
         Width           =   2655
      End
      Begin VB.CommandButton Command6 
         Caption         =   "Dossier de collection"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   120
         TabIndex        =   11
         Top             =   360
         Width           =   2655
      End
      Begin VB.Label nb_file2 
         Caption         =   "Label1"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   2880
         TabIndex        =   18
         Top             =   3000
         Width           =   855
      End
   End
   Begin VB.CommandButton Command5 
      Caption         =   "Compilation Projet"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   735
      Left            =   4440
      TabIndex        =   9
      Top             =   3480
      Width           =   4215
   End
   Begin VB.CommandButton Command4 
      Caption         =   "Rangement des fichiers"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   735
      Left            =   120
      TabIndex        =   7
      Top             =   3480
      Width           =   4215
   End
   Begin VB.Frame Frame1 
      Caption         =   "Partie VirusTotal"
      Height          =   3255
      Left            =   120
      TabIndex        =   0
      Top             =   120
      Width           =   8535
      Begin VB.CheckBox chk_visible 
         Caption         =   "Toujours visible"
         Height          =   255
         Left            =   6480
         TabIndex        =   8
         Top             =   1680
         Width           =   1935
      End
      Begin VB.CommandButton Command3 
         Caption         =   "Création du fichier HTML avec informations de VirusTotal"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   13.5
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   615
         Left            =   120
         TabIndex        =   6
         Top             =   2520
         Width           =   8295
      End
      Begin VB.CommandButton Command2 
         Caption         =   "Suppression Malwares"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   6480
         TabIndex        =   4
         Top             =   1080
         Width           =   1935
      End
      Begin VB.CommandButton Command1 
         Caption         =   "Envoie à VirusTotal"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   495
         Left            =   6480
         TabIndex        =   3
         Top             =   360
         Width           =   1935
      End
      Begin VB.FileListBox File1 
         Height          =   2040
         Left            =   3360
         MultiSelect     =   2  'Extended
         TabIndex        =   2
         Top             =   360
         Width           =   3015
      End
      Begin VB.DirListBox Dir1 
         Height          =   2115
         Left            =   120
         TabIndex        =   1
         Top             =   360
         Width           =   3015
      End
      Begin VB.Label nb_file1 
         Caption         =   "Label1"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   6480
         TabIndex        =   5
         Top             =   2160
         Width           =   1935
      End
   End
   Begin VB.Label Label1 
      Caption         =   "Malwares Analyses Tools by PetiK - 12/09/2009"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   255
      Left            =   4440
      TabIndex        =   19
      Top             =   8520
      Width           =   4215
   End
End
Attribute VB_Name = "Form1"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Private Declare Function DeleteFile Lib "kernel32" Alias "DeleteFileA" (ByVal lpFileName As String) As Long
Private Declare Function FindWindow Lib "user32" Alias "FindWindowA" (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function SetForegroundWindow Lib "user32" (ByVal hwnd As Long) As Long
Private Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
Private Declare Function WinExec Lib "kernel32" (ByVal lpCmdLine As String, ByVal nCmdShow As Long) As Long
Private Declare Function MoveFile Lib "kernel32" Alias "MoveFileA" (ByVal lpExistingFileName As String, ByVal lpNewFileName As String) As Long
Private Declare Function CopyFile Lib "kernel32" Alias "CopyFileA" (ByVal lpExistingFileName As String, ByVal lpNewFileName As String, ByVal bFailIfExists As Long) As Long


Private Const SWP_NOSIZE = &H1
Private Const SWP_NOMOVE = &H2
Private Const HWND_TOPMOST = -1
Private Const HWND_NOTOPMOST = -2
Private Declare Function SetWindowPos Lib "user32" (ByVal hwnd As Long, ByVal hWndInsertAfter As Long, ByVal X As Long, ByVal Y As Long, ByVal cx As Long, ByVal cy As Long, ByVal wFlags As Long) As Long
Const BIF_RETURNONLYFSDIRS = 1
Const MAX_PATH = 260
Private Declare Sub CoTaskMemFree Lib "ole32.dll" (ByVal hMem As Long)
Private Declare Function lstrcat Lib "kernel32" Alias "lstrcatA" (ByVal lpString1 As String, ByVal lpString2 As String) As Long
Private Declare Function SHBrowseForFolder Lib "shell32" (lpbi As BrowseInfo) As Long
Private Declare Function SHGetPathFromIDList Lib "shell32" (ByVal pidList As Long, ByVal lpBuffer As String) As Long
Private Type BrowseInfo
    hWndOwner As Long
    pIDLRoot As Long
    pszDisplayName As Long
    lpszTitle As Long
    ulFlags As Long
    lpfnCallback As Long
    lParam As Long
    iImage As Long
End Type

'Option Explicit

Private m_cancel As Boolean

Private Sub PremierPlan(F As Form)
' appel de la fontion
Call SetWindowPos(F.hwnd, HWND_TOPMOST, 0&, 0&, 0&, 0&, (SWP_NOSIZE Or SWP_NOMOVE))
End Sub

Private Sub PlanNormal(F As Form)
' appel de la fontion
Call SetWindowPos(F.hwnd, HWND_NOTOPMOST, 0&, 0&, 0&, 0&, (SWP_NOSIZE Or SWP_NOMOVE))
End Sub


Private Sub chk_visible_Click()
If chk_visible.Value = 1 Then
PremierPlan Me
Else
PlanNormal Me
End If
End Sub

Private Sub Command1_Click()
Dim vt As String
Dim i As Integer
vt = "C:\Program Files\VirusTotalUploader\VirusTotalUpload.exe "
For i = 0 To File1.ListCount - 1
If File1.Selected(i) = True Then

WinExec vt & Dir1.Path & "\" & File1.List(i), 10

End If
Next i
End Sub

Private Sub Command2_Click()
Dim i As Integer
For i = 0 To File1.ListCount - 1
If File1.Selected(i) = True Then

DeleteFile Dir1.Path & "\" & File1.List(i)
'MsgBox Dir1.Path & "\" & File1.List(i)

End If
Next i

File1.Refresh
nb_file1.Caption = File1.ListCount & " file(s)"
End Sub

Private Sub Command3_Click()
    Dim lHandle As Long
    Dim ligne_de_code As String
    Dim nom_du_malware As String
    Dim ctrl As Integer
    Dim i As String
    
    'ctrl = 1
    'Clipboard.Clear
    'Sleep 150

    
    'lHandle = FindWindow(vbNullString, "VirusTotal - Mozilla Firefox")
    'lHandle = SetForegroundWindow(lHandle)
    'SendKeys ("jknnkn")
    'Sleep 300
    'SendKeys ("^c")
    'Sleep 50
    'SendKeys ("^c")
    'Sleep 50
    'SendKeys ("^c")
    'Sleep 50
    'SendKeys ("^c")
    'Sleep 50
    'Do Until Left(Clipboard.GetText, 13) = "<table border"
    'ctrl = ctrl + 1     ' Gestion erreur pour ne pas tourner indéfiniment
    'If ctrl = 200 Then
    'MsgBox "Error to copy the <table> line" & ctrl, vbCritical
    'Exit Sub
    'SendKeys ("^c")
    'Sleep 50
    'SendKeys ("^c")
    'Sleep 50
    'SendKeys ("^c")
    'Sleep 50
    'SendKeys ("^c")
    'Sleep 100
    'End If
    
    'Loop
    ligne_de_code = Clipboard.GetText
    'lHandle = FindWindow(vbNullString, Me.Caption)
    'lHandle = SetForegroundWindow(lHandle)
    
    ' On recherche le titre
    i = 44
    nom_du_malware = ""
    Do Until Mid(ligne_de_code, i, 1) = " "
    nom_du_malware = nom_du_malware + Mid(ligne_de_code, i, 1)
    i = i + 1
    If i = 200 Then
    MsgBox "Error to copy the <table> line" & ctrl, vbCritical
    Exit Sub
    End If
    Loop
    
    ' On va creer le fichier
    
    Open nom_du_malware & "-names.html" For Output As #1   ' Ouvre le fichier en écriture.
    Print #1, "<!DOCTYPE html PUBLIC ""-//W3C//DTD HTML 4.01//EN"" ""http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd"">"
    Print #1, "<html>"
    Print #1, "<head>"
    Print #1, "<META http-equiv=Content-Type content=""text/html; charset=windows-1252"">"
    Print #1, "<title>" & nom_du_malware & "</title>"
    Print #1, "<style type=""text/css"">"
    Print #1, "span {"
    Print #1, " font-family: 'Courier New';"
    Print #1, " font-size: 10pt;"
    Print #1, " color: #000000;"
    Print #1, "}"
    Print #1, ".sc0 {"
    Print #1, "}"
    Print #1, "</style>"
    Print #1, "</head>"
    Print #1, "<body>"
    Print #1, "<div style=""float: center; white-space: pre; line-height: 1; background: #FFFFFF; "">"
    Print #1, "<span class=""sc0""><center><h1>Analysis of " & nom_du_malware & "</h1></center>"
    Print #1, "<b>" & ligne_de_code & ""
    Print #1, "<br>Scanned on " & Date & " (French Date) at " & Time & "</b>"
    Print #1, "</span></div></body></html>"
    Close #1
    
    Me.Caption = "Malwares Analyses Tools - " & nom_du_malware



End Sub

Private Sub Command4_Click()
Dim i As Integer
Dim type_malware As String
Dim lang_malware As String
Set fso = CreateObject("scripting.filesystemobject")

dm = App.Path
'cd = collection_dest.Text
Set dossier_malwares = fso.GetFolder(dm)
For Each fichier In dossier_malwares.Files

If LCase(fso.GetExtensionName(fichier.Name)) = "html" And fichier.Name <> "index.html" And fichier.Name <> "creation_du_projet_malwares_analyses.vbs.html" Then

i = 1
type_malware = ""
lang_malware = ""

Do Until Mid(fichier.Name, i, 1) = "."
type_malware = type_malware & Mid(fichier.Name, i, 1)
i = i + 1
If i > 70 Then Exit Do
Loop

'On créée le premier dossier si n'existe pas
If Not fso.FolderExists(App.Path & "\" & type_malware) Then
fso.CreateFolder (App.Path & "\" & type_malware)
End If

i = i + 1
Do Until Mid(fichier.Name, i, 1) = "."
lang_malware = lang_malware & Mid(fichier.Name, i, 1)
i = i + 1
If i > 70 Then Exit Do
Loop

'On créée le deuxième dossier si n'existe pas
If Not fso.FolderExists(App.Path & "\" & type_malware & "\" & lang_malware) Then
fso.CreateFolder (App.Path & "\" & type_malware & "\" & lang_malware)
End If

'MsgBox App.Path & "\" & type_malware & "\" & lang_malware & "\" & fichier.Name

MoveFile fichier.Path, App.Path & "\" & type_malware & "\" & lang_malware & "\" & fichier.Name
'If fso.FileExists(fichier.Path) Then
'DeleteFile fichier.Path
'End If

End If

Next

MsgBox "Rangement effectué", vbInformation

End Sub

Private Sub Command5_Click()
WinExec "wscript.exe creation_du_projet_malwares_analyses.vbs", 10
End Sub

Private Sub Command6_Click()
    Dim iNull As Integer, lpIDList As Long, lResult As Long
    Dim sPath As String, udtBI As BrowseInfo
    With udtBI
        'Set the owner window
        .hWndOwner = Me.hwnd
        'lstrcat appends the two strings and returns the memory address
        .lpszTitle = lstrcat("Veuilez indiquer le dossier de votre collection", "")
        'Return only if the user selected a directory
        .ulFlags = BIF_RETURNONLYFSDIRS
    End With

    'Show the 'Browse for folder' dialog
    lpIDList = SHBrowseForFolder(udtBI)
    If lpIDList Then
        sPath = String$(MAX_PATH, 0)
        'Get the path from the IDList
        SHGetPathFromIDList lpIDList, sPath
        'free the block of memory
        CoTaskMemFree lpIDList
        iNull = InStr(sPath, vbNullChar)
        If iNull Then
            sPath = Left$(sPath, iNull - 1)
            Dir2.Path = sPath
            txtdossiercollection.Text = sPath
        End If
    End If
End Sub

Private Sub Command7_Click()
Dim dossier_collection As String
m_cancel = False
lst_mal_trait.Clear
If txtdossiercollection.Text = "" Then Exit Sub
Set fso = CreateObject("scripting.filesystemobject")
dossier_collection = Dir2.Path

Set dos1 = fso.GetFolder(dossier_collection)
For Each fichier1 In dos1.Files
mal_inspect = ""
mal_inspect = mal_inspect & App.Path
mal_inspect = mal_inspect & Right(fso.GetAbsolutePathName(dossier_collection), Len(dossier_collection) - Len(txtdossiercollection.Text))
mal_inspect = mal_inspect & "\" & fichier1.Name & "-names.html"
If Not fso.FileExists(mal_inspect) Then lst_mal_trait.AddItem (fichier1.Path)
nb_file2.Caption = lst_mal_trait.ListCount & " file(s)"

DoEvents
If m_cancel Then Exit For

Next

Set dos2 = dos1.SubFolders
For Each dossier_dedans In dos2

Set dos2 = fso.GetFolder(dossier_dedans.Path)
For Each fichier2 In dos2.Files

mal_inspect = ""
mal_inspect = mal_inspect & App.Path
mal_inspect = mal_inspect & Right(fso.GetAbsolutePathName(dossier_dedans.Path), Len(dossier_dedans.Path) - Len(txtdossiercollection.Text))
mal_inspect = mal_inspect & "\" & fichier2.Name & "-names.html"

If Not fso.FileExists(mal_inspect) Then lst_mal_trait.AddItem (fichier2.Path)
nb_file2.Caption = lst_mal_trait.ListCount & " file(s)"

DoEvents
If m_cancel Then Exit For

Next

Next

End Sub

Private Sub Command8_Click()
m_cancel = True
End Sub

Private Sub Command9_Click()
Set fso = CreateObject("scripting.filesystemobject")
If Not fso.FolderExists(App.Path & "\a_faire") Then fso.CreateFolder (App.Path & "\a_faire")
For i = 0 To lst_mal_trait.ListCount - 1
If lst_mal_trait.Selected(i) = True Then

CopyFile lst_mal_trait.List(i), App.Path & "\a_faire\" & fso.GetFileName(lst_mal_trait.List(i)), 0

End If
Next i
Dir1.Path = App.Path & "\a_faire"
File1.Refresh
End Sub

Private Sub Dir1_Change()
File1.Path = Dir1.Path
nb_file1.Caption = File1.ListCount & " file(s)"
End Sub

Private Sub File1_DblClick()
Call lire_code(File1.Path & "\" & File1, File1, Form2)
End Sub

Private Sub Form_Load()
nb_file1.Caption = File1.ListCount & " file(s)"
nb_file2.Caption = ""
lst_mal_trait.Clear

End Sub

Sub lire_code(fichier_a_lire As String, titre As String, formulaire As Form2)
Dim TextLine
Dim code_malware As String
code_malware = ""
Open fichier_a_lire For Input As #1   ' Ouvre le fichier.
Do While Not EOF(1)   ' Effectue la boucle jusqu'à la fin du fichier.
   Line Input #1, TextLine      ' Lit la ligne dans la variable.
   code_malware = code_malware & TextLine & vbCrLf   ' Affiche dans la fenêtre Exécution.
Loop
Close #1   ' Ferme le fichier.

formulaire.Caption = titre
formulaire.text_code.Text = code_malware
formulaire.Show

End Sub


Private Sub lst_mal_trait_DblClick()
Call lire_code(File1.Path & "\" & File1, File1, Form2)
End Sub
